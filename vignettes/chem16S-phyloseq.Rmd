---
title: "Chemical analysis of microbiomes with chem16S and phyloseq"
author: "Jeffrey M. Dick"
output:
  html_document:
    mathjax: null
    toc: true
    css: style.css
vignette: >
  %\VignetteIndexEntry{Chemical analysis of microbiomes with chem16S and phyloseq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: chem16S.bib
csl: elementa.csl
link-citations: true
---

```{r HTML, include = FALSE}
Zc <- "<i>Z</i><sub>C</sub>"
nH2O <- "<i>n</i><sub>H<sub>2</sub>O</sub>"
nO2 <- "<i>n</i>O<sub>2</sub>"
H2O <- "<sub>H<sub>2</sub>O</sub>"
O2 <- "O<sub>2</sub>"
```

```{r setup, echo = FALSE}
options(width = 80)
# Use pngquant to optimize PNG images
library(knitr)
knit_hooks$set(pngquant = hook_pngquant)
pngquant <- "--speed=1 --quality=0-25"
if (!nzchar(Sys.which("pngquant"))) pngquant <- NULL
# To make warnings appear in text box 20230619
# https://selbydavid.com/2017/06/18/rmarkdown-alerts/
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error:**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning:**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('\n\n<div class="alert alert-info">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
# Don't evaluate chunks if phyloseq is not available 20230619
if(!requireNamespace("phyloseq", quietly = TRUE)) {
  knitr::opts_chunk$set(eval = FALSE)
  day <- imin <- AA.RDP <- map.RDP <- map.silva <- NULL
  warning("The **phyloseq** package is not available, so this vignette shows only the code without the results.")
}
```

This vignette demonstrates the integration of **chem16S** with **phyloseq** to calculate chemical metrics of community reference proteomes.

- *Chemical metrics* are molecular properties computed from elemental compositions -- inferred from amino acid compositions of proteins -- and include carbon oxidation state (`r Zc`) and stoichiometric hydration state (`r nH2O`), as described by @DYT20.
  **chem16S** uses the `Zc()` and `nH2O()` functions from the **canprot** package to calculate chemical metrics.
- *Community reference proteomes* are generated by combining lowest-level taxonomic assignments (from genus to phylum) with reference proteomes for taxa.
  Precomputed reference proteomes for taxa are available for the GTDB and RefSeq reference databases (the latter was described by @DT23).

## Load required packages

```{r load_packages}
library(chem16S)
library(phyloseq)
library(ggplot2)
theme_set(theme_bw())
```

This vignette was compiled on `r Sys.Date()` with **chem16S** version `r sessionInfo()$otherPkgs$chem16S$Version` and **phyloseq** version `r sessionInfo()$otherPkgs$phyloseq$Version`.

## Mouse microbiome data

The [mothur MiSeq SOP](https://mothur.org/wiki/miseq_sop/) has an example dataset with 16S rRNA sequences for mouse gut communities.
This example dataset includes data collected at 0--9 (early) and 141-150 (late) days post-weaning from one mouse.
This dataset is used in the [DADA2 Pipeline Tutorial](https://benjjneb.github.io/dada2/tutorial.html) to demonstrate construction of amplicon sequence variants (ASV), taxonomic classification of the ASVs, and analysis using the **phyloseq** package.
Here, we load the phyloseq object that was created on 2023-06-14 using dada2 (version 1.28.0) following the steps in the DADA2 pipeline tutorial (version 1.16).
Note that taxonomy was assigned to genus level using a newer version of the Silva training set ([`silva_nr99_v138.1_train_set.fa.gz`](https://zenodo.org/record/4587954)) than that indicated in the DADA2 tutorial on this date (`silva_nr_v132_train_set.fa.gz`).

```{r load_mouse.silva}
data(mouse.silva)
mouse.silva
```

To quickly visualize this data, let's reproduce the bar plot from the DADA2 tutorial:

```{r ps_dada2_barplot, fig.width = 8, fig.height = 5, fig.align = "center", pngquant = pngquant}
top20.silva <- names(sort(taxa_sums(mouse.silva), decreasing = TRUE))[1:20]
mouse.silva.top20 <- transform_sample_counts(mouse.silva, function(OTU) OTU/sum(OTU))
mouse.silva.top20 <- prune_taxa(top20.silva, mouse.silva.top20)
plot_bar(mouse.silva.top20, x = "Day", fill = "Phylum") + facet_wrap(~When, scales = "free_x")
```

## Lowest-level taxa

The **chem16S** package contains the amino acid compositions of archaeal, bacterial, and viral taxa at levels from genus to phylum constructed from the RefSeq database; see the vignette [**Chemical metrics of reference proteomes for taxa**](reference-proteomes.html) for more information.
There are denoted as *reference proteomes* for taxa.
Several functions are available to identify the lowest-level taxon for each classified read (or in this case, each ASV), combine the reference proteomes for all taxa to create *community reference proteomes*, and calculate chemical metrics from them.

First, let's make a table that lists the lowest-level taxon for each ASV and their abundances.
Because **chem16S** was first developed to analyze the output from the RDP Classifier, this data frame has a similar format to the file created by using the `classify -h` command of the RDP Classifier followed by the `merge-count` command.
That is, the data frame has columns named `taxid`, `rank`, `lineage`, and `name`, followed by columns for all samples.

```{r mouse.silva_taxacounts}
tc.silva <- ps_taxacounts(mouse.silva)
```

ASVs with identical lowest-level taxonomic assignments are merged, so this data frame has fewer rows than the number of ASVs.
The short names of the ASVs are stored in the `taxid` column, and the names of multiple ASVs with the same lowest-level taxonomic classification are separated by a semicolon.
The ASVs themselves (DNA sequences, not short names) are available in the phyloseq object as explained in the DADA2 tutorial, but are not used here.
Now we can look at the number of unique lowest-level classifications at each taxonomic level:

```{r mouse.silva_levels, collapse = TRUE}
table(tc.silva$rank)
```

These taxa will be used below to construct community reference proteomes.

## Taxonomic mapping

A challenge of using reference proteomes is that they come from one source (GTDB and RefSeq are available in chem16S), but taxonomic assignments may be made using a different training set (such as Silva or RDP).
While identical names can be automatically matched from taxonomic assignments to reference proteomes, those with different names pose difficulties.
For example, RDP uses the name *Escherichia/Shigella*, while RefSeq has *Escherichia*.
This and other manual mappings were proposed by @DT23 for mapping between RDP and RefSeq.

Let's try out the mapping with the phyloseq object created using the Silva training set.

```{r map.silva, collapse = TRUE}
map.silva <- map_taxa(tc.silva, refdb = "RefSeq")
```

The messages show that one group was manually mapped, and the total mapped (both automatic and manual) abundance is `r round(100 - sum(attr(map.silva, "unmapped_percent")), 1)`% of the dataset.
We can increase the mapped percent by using classifications generated with the RDP training set, for which manual mappings to RefSeq were proposed by @DT23.

```{r map.RDP, collapse = TRUE}
data(mouse.RDP)
tc.RDP <- ps_taxacounts(mouse.RDP)
map.RDP <- map_taxa(tc.RDP, refdb = "RefSeq")
```

Now the total mapped abundance is `r round(100 - sum(attr(map.RDP, "unmapped_percent")), 1)`%. 

::: {.infobox .note}
Manual mapping does not overcome inconsistencies between different taxonomies but is simply a starting point for using more of the data to assess chemical differences between communities.
Using the Genome Taxonomy Database (GTDB) for both taxonomic classification and reference proteomes obviates the need for manual mapping and is described further below.
:::

## From taxonomy to amino acid composition

The `ps_metrics()` function in chem16S wraps the previous two functions (`ps_taxacounts()` and `map_taxa()`) as well as another function (`get_metrics()`).
In order, these functions get the lowest-level taxa for each assignment, map taxonomic names to RefSeq by automatic and manual name matching, and combine taxonomic abundances with reference proteomes for taxa to calculate the amino acid composition of community reference proteomes, which are then used to calculate chemical metrics.
To peek into this process, let's first request just the amino acid composition of the community reference proteomes.

```{r AA.RDP, collapse = TRUE}
AA.RDP <- ps_metrics(mouse.RDP, refdb = "RefSeq", quiet = TRUE, return_AA = TRUE)
head(AA.RDP)
```

In this data frame, columns named `Run` and `chains` have the sample name and abundance-weighted number of reference proteomes (i.e., the total abundance of ASVs that have taxonomic classifications with mappings to the RefSeq taxonomy) used to construct the amino acid composition.
We can use this to calculate the average protein length of the reference proteomes in each community and make a histogram:

```{r AA.RDP_length, fig.width = 7, fig.height = 5, fig.align = "center", pngquant = pngquant}
lengths <- rowSums(AA.RDP[, -(1:2)]) / AA.RDP$chains
hist(lengths)
imin <- which.min(lengths)
text(lengths[imin], 1.5, AA.RDP$Run[imin], adj = 1)
```

Sample `r AA.RDP$Run[imin]` (from Day `r if(!is.null(AA.RDP)) strsplit(AA.RDP$Run[imin], "D")[[1]][2]`) has the lowest average protein length of the reference proteomes in the community and might even be an outlier.

## From taxonomy to chemical metrics

We're now ready to calculcate chemical metrics from the amino acid composition.

```{r metrics.RDP, collapse = TRUE}
metrics.RDP <- ps_metrics(mouse.RDP, refdb = "RefSeq", quiet = TRUE)
head(metrics.RDP)
```

This data frame has three columns for `r Zc` (carbon oxidation state), `r nO2` (stoichiometric oxidation state), and `r nH2O` (stoichiometric hydration state).
`Zc` is computed from the elemental formula, while `r nO2` and `r nH2O` are coefficients on `r O2` and `r nH2O` in theoretical formation reactions of the proteins from a particular set of thermodynamic components, also known as basis species.
The considerations for the basis species used here (glutamine, glutamic acid, cysteine, `r O2`, and `r nH2O`, abbreviated as QEC) are described in @DT23.
Because they are both measures of oxidation state, we expect to see a strong positive correlation between `r Zc` and `r nO2`.
For this dataset, there is in addition a strong negative correlation between `r Zc` and `r nH2O`; importantly, other datasets do not show such a correlation.

```{r cor.RDP, collapse = TRUE}
cor(metrics.RDP$Zc, metrics.RDP$nO2)
cor(metrics.RDP$Zc, metrics.RDP$nH2O)
```

Let's plot the chemical metrics, each one against the sampling day.

```{r plot_metrics.RDP, fig.width = 7, fig.height = 5, fig.align = "center", pngquant = pngquant}
plot_ps_metrics(mouse.RDP, x = "Day", color = "When", refdb = "RefSeq", quiet = TRUE)
```

Let's plot two chemical metrics against each other.

```{r plot_metrics2.RDP, fig.width = 6, fig.height = 4, fig.align = "center", pngquant = pngquant}
plot_ps_metrics2(mouse.RDP, color = "When", refdb = "RefSeq", quiet = TRUE)
```

The community reference proteomes for Late samples tend to be more oxidized and less hydrated (i.e., they have higher `r Zc` and lower `r nH2O`) than Early samples, but there is some overlap between the groups.

## Using GTDB for reference proteomes

As noted above, mapping taxon names from Silva or RDP to RefSeq is not perfect.
To overcome this limitation, the GTDB can be used for both taxonomic classification of 16S rRNA sequences and for reference proteomes of taxa.
Here we load a phyloseq dataset prepared following the DADA2 Pipeline Tutorial with the substitution of the GTDB training set.
Then, we plot chemical metrics calculated for reference proteomes derived from the same version of the GTDB.

::: {.infobox .note}
`refdb = "GTDB"` is the default option for functions in **chem16S**, so the argument does not need to be explicitly given.
:::

```{r data.GTDB, collapse = TRUE, fig.width = 6, fig.height = 4, fig.align = "center", pngquant = pngquant}
data(mouse.GTDB)
plot_ps_metrics2(mouse.GTDB, color = "When")
```

Compared to using the RDP for classification of 16S rRNA sequences and RefSeq for reference proteomes, using the GTDB for both yields a clearer separation of Early and Late samples in chemical space.
There is one Early sample with anomalously high `r Zc` and low `r nH2O`; let's identify it:

```{r early.GTDB, collapse = TRUE, fig.width = 6, fig.height = 4, fig.align = "center", pngquant = pngquant}
metrics.GTDB <- ps_metrics(mouse.GTDB)
is.early <- sample_data(mouse.GTDB)$When == "Early"
iout <- which.min(metrics.GTDB[is.early, ]$nH2O)
(day <- sample_data(mouse.GTDB)[is.early, ]$Day[iout])
```

This is the sample from day `r day`.
Let's look again at the taxonomic classifications, this time at the phylum level in the GTDB:

```{r barplot.GTDB, fig.width = 8, fig.height = 5, fig.align = "center", pngquant = pngquant}
top20.GTDB <- names(sort(taxa_sums(mouse.GTDB), decreasing = TRUE))[1:20]
mouse.GTDB.top20 <- transform_sample_counts(mouse.GTDB, function(OTU) OTU/sum(OTU))
mouse.GTDB.top20 <- prune_taxa(top20.GTDB, mouse.GTDB.top20)
plot_bar(mouse.GTDB.top20, x = "Day", fill = "Phylum") + facet_wrap(~When, scales = "free_x")
```

This plot suggests that a relatively high proportion of taxa in the Bacteroidota phylum makes the Day `r day` sample more similar to samples in the Late group.
Bacteroidetes (the older name for this phylum) have some of the lowest `r nH2O` among major bacterial phyla [see @DT23]; this may help to explain the differences observed for the Day `r day` sample.

## Take-home messages

1. Taxonomic mapping from Silva to RefSeq or RDP to RefSeq is incomplete.
   If you do this, it is advisable to at least report the percentage of mapped taxonomic classifications as well as the major unmapped groups,
   which can be listed with the `quiet = FALSE` argument to `map_taxa()`, `ps_metrics()`, `plot_ps_metrics()`, and `plot_ps_metrics2()`.
2. Consistent taxonomy can be achieved by using the GTDB for both reference proteomes and 16S rRNA classification.
   For the dataset analyzed here, this leads to a clearer separation between sample groups in chemical space and helps to identify the taxonomic basis for outliers.
2. A chemical analysis suggests that gut communities in later stages of mouse growth are characterized by relatively oxidized and dehydrated reference proteomes.
   Visualizing the chemical metrics of communities can provide insight beyond conventional diversity metrics.
   See the next vignette ([*It isn't ordination*](it-isnt-ordination.html)) for more examples.

## References
